<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <title>Puppet - Common Anti-Patterns</title>
    <meta name="description" content="" />

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link rel="shortcut icon" href="http://www.pysysops.com/favicon.ico">

    <link rel="stylesheet" type="text/css" href="//www.pysysops.com/themes/casper/assets/css/screen.css?v=1484110163745" />
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />

    <link rel="canonical" href="http://www.pysysops.com/2016/11/10/1123-Puppet-Common-Anti-Patterns.html" />
    <meta name="referrer" content="origin" />
    
    <meta property="og:site_name" content="Tim Birkett " />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Puppet - Common Anti-Patterns" />
    <meta property="og:description" content="Over my years in the tech industry I&amp;#8217;ve gained a lot of experience with Configuration Managemnt tools such as Puppet, Chef and Ansible. In this post I&amp;#8217;d like to share with you my experiences, opinions and advice on using Puppet as a Configuration Management tool. Hopefully" />
    <meta property="og:url" content="http://www.pysysops.com/2016/11/10/1123-Puppet-Common-Anti-Patterns.html" />
    <meta property="article:tag" content="Puppet" />
    <meta property="article:tag" content=" Automation" />
    <meta property="article:tag" content=" Configuration Management" />
    <meta property="article:tag" content=" Devops" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Puppet - Common Anti-Patterns" />
    <meta name="twitter:description" content="Over my years in the tech industry I&amp;#8217;ve gained a lot of experience with Configuration Managemnt tools such as Puppet, Chef and Ansible. In this post I&amp;#8217;d like to share with you my experiences, opinions and advice on using Puppet as a Configuration Management tool. Hopefully" />
    <meta name="twitter:url" content="http://www.pysysops.com/2016/11/10/1123-Puppet-Common-Anti-Patterns.html" />
    
    <script type="application/ld+json">
null
    </script>

    <meta name="generator" content="HubPress" />
    <link rel="alternate" type="application/rss+xml" title="Tim Birkett " href="http://www.pysysops.com/rss/" />
</head>
<body class="post-template tag-Puppet tag-Automation tag-Configuration-Management tag-Devops nav-closed">

    

    <div class="site-wrapper">

        


<header class="main-header post-head no-cover">
    <nav class="main-nav  clearfix">
        
    </nav>
</header>

<main class="content" role="main">
    <article class="post tag-Puppet tag-Automation tag-Configuration-Management tag-Devops">

        <header class="post-header">
            <h1 class="post-title">Puppet - Common Anti-Patterns</h1>
            <section class="post-meta">
                <time class="post-date" datetime="2016-11-10">10 November 2016</time>  on <a href="http://www.pysysops.com/tag/Puppet/">Puppet</a>, <a href="http://www.pysysops.com/tag/Automation/"> Automation</a>, <a href="http://www.pysysops.com/tag/Configuration-Management/"> Configuration Management</a>, <a href="http://www.pysysops.com/tag/Devops/"> Devops</a>
            </section>
        </header>

        <section class="post-content">
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Over my years in the tech industry I&#8217;ve gained a lot of experience with Configuration Managemnt tools such as Puppet, Chef and Ansible. In this post I&#8217;d like to share with you my experiences, opinions and advice on using Puppet as a Configuration Management tool. Hopefully this helps some of you out there to beat Puppet into submission.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_everything_in_manifests">Everything in Manifests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In many beginners tutorials you get taught to put all your code in manifests such as <code>site.pp</code> or <code>nodes.pp</code>. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>node 'puppetclient1.mydomain.net' {
  include httpd_class
}

node 'puppetclient2.mydomain.net' {
  include nginx_class
  file {'/opt/deployment_script':
    ensure =&gt; 'file',
    owner  =&gt; 'deploy',
    group  =&gt; 'deploy',
    mode   =&gt; '0750'
  }
}

node default {
  package { 'perl':
    ensure =&gt; present
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is great when you&#8217;re just starting out with a few servers to manage. You think you get it. Then you add a few more servers, you start adding more node specific config and before you know it you&#8217;ve got 10'000 lines of hand-crafted artisanal Puppet code. Much of which is probably duplicated. This was common in the early deys of Puppet use. It was how I started back with Puppet 0.24.</p>
</div>
<div class="paragraph">
<p>Although, it&#8217;s not the best idea to manage your infrastructure in this way it&#8217;s actually a reasonably good way to very easily and simply bootstrap cloud instances. with separate manifests based on server type (<code>web.pp</code>, <code>app.pp</code>, <code>lb.pp</code> etc). These can than be applied using <a href="https://cloudinit.readthedocs.io/en/latest/">cloudinit</a> to create an immutable bootstrapped node.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_monolithic_code_modules_code_directory">Monolithic <code>modules</code> Directory</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Quite often I see repos where either people have <code>puppet module install&#8217;d straight into the `modules</code> directory or they&#8217;ve downloaded a module and extracted it there. They then commit the whole repo including their own modules mixed in with upstream modules into source control.</p>
</div>
<div class="paragraph">
<p>This pattern has a few problems, you don&#8217;t know what is a locally developed module and what is an upstream module and there&#8217;s no way of easily seeing what versions of modules are deployed. It also adds a lot of extra code to your Puppet repository.</p>
</div>
<div class="paragraph">
<p>Although this way works and you know that your module versions are pinned, tools are out there that make it much easier to manage your Puppet modules such as <a href="http://librarian-puppet.com/">librarian-puppet</a> and <a href="https://github.com/puppetlabs/r10k">r10k</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration_data_in_code">Configuration Data in Code</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When writing Puppet code it&#8217;s sometimes tempting to hard-code things like IP addresses or node specific things. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># DNS Config
class profile::base::dns{
  $dns_servers = ['192.168.1.1', '192.168.1.2']
  file { '/etc/resolv.conf':
    ensure  =&gt; present,
    owner   =&gt; 'root',
    group   =&gt; 'root',
    mode    =&gt; '0444',
    content =&gt; template('etc/resolv.conf.erb')
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This works, but the code isn&#8217;t re-usable. If you deploy to a different network or DC are your DNS servers still the same?</p>
</div>
<div class="paragraph">
<p>To improve re-usablility, change the variable to be a class parameter with an optional default value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># DNS Config
class profile::base::dns (
  $dns_servers = ['8.8.8.8', '8.8.4.4']
){
  file { '/etc/resolv.conf':
    ensure  =&gt; present,
    owner   =&gt; 'root',
    group   =&gt; 'root',
    mode    =&gt; '0444',
    content =&gt; template('etc/resolv.conf.erb')
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can specify environment (network, node, DC) specific things in Hiera:</p>
</div>
<div class="paragraph">
<p>dc1.example.com.yaml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>---
profile::base::dns:
  dns_servers:
    - '192.168.1.1'
    - '192.168.1.2'</code></pre>
</div>
</div>
<div class="paragraph">
<p>dc2.example.com.yaml:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>---
profile::base::dns:
  dns_servers:
    - '10.10.0.1'
    - '10.10.1.1'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now you avoid multiple classes or writing <code>case</code> or <code>if {&#8230;&#8203;} else {&#8230;&#8203;}</code> logic in your class file.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_everything_in_separate_repos">Everything in Separate Repos</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you can see above, I&#8217;ve mentioned a "profile" class. A common pattern when dealing with Puppet code is the <strong>Roles and Profiles Pattern</strong>. The idea is that you assign one "Role" per server and the role is made up of individual bite-sized "Profiles". Roles and profiles are just you or your companies custom Puppet modules that make use of upstream modules or Puppet resources to configure systems.</p>
</div>
<div class="paragraph">
<p>A common and problematic pattern I&#8217;ve seen is maintaining an SCM repo for roles, an SCM repo for profiles, an SCM repo for the "control repo" and a separate SCM repo for hieradata. This can then turn into multiple branches of each and before you know it you&#8217;re maintaining 12 versions of a diverging code base. It&#8217;s common to see this when people have followed some "best practice" blog post without fully thinking things through. You also often see this when developers created the code initially. They love git branches and complexity. Especially if trying to bring Gitflow to Puppet code.</p>
</div>
<div class="paragraph">
<p>Here&#8217;s my top tip when deciding how to organize your repos: KISS - Have no more than one repo for your Puppet code. Multiple repos and branches leads to managing multiple very different code bases, different module versions in each environment, merge tasks, complex git fixing&#8230;&#8203; a nightmare. There is an awesome control-repo by the guys at Example42 here: <a href="https://github.com/example42/control-repo" class="bare">https://github.com/example42/control-repo</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_misuse_of_puppet_environments">Misuse of Puppet Environments</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With the r10k tool, it&#8217;s easy to manage environments dynamically with Git branches. You can then assign subsets of servers to different branches of Puppet code. This sounds great, we have applications deployed to different environments like test, dev, stage, uat or production. Cool! let&#8217;s create all those branches&#8230;&#8203; STOP!!</p>
</div>
<div class="paragraph">
<p>Puppet environments are a powerful thing, but I don&#8217;t believe you should confuse Puppet environments with Application environments. You should aim to manage your infrastructure in a single Puppet environment: "production". If you arrange your hieradata hierarchy sensibly you can manage the differences in configuration in a single branch.</p>
</div>
<div class="paragraph">
<p>Puppet branches should be used when you need to test big changes or new features out in a controlled way (of course you&#8217;re developing and testing on Vagrant). Create a branch like "new_feature", develop it locally testing it on Vagrant then test out the changes on a suitable piece of infrastructure by running <code>puppet apply --environment new_feature</code>. Don&#8217;t forget your security and perf testing at this point ;) if everything looks good, open a PR, get it reviewed, merged to production and delete the branch.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_closing_thoughts">Closing Thoughts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Most of the opinions I&#8217;ve formed are from being forced to work with some painful Puppet code setups and processes. My best advice to anyone developing their infrastructure code: Keep it simple, think about it before you go ahead, keep an open mind and don&#8217;t be afraid to change your mind or refactor when necessary.</p>
</div>
</div>
</div>
        </section>

        <footer class="post-footer">


            <figure class="author-image">
                <a class="img" href="http://www.pysysops.com/author/pysysops/" style="background-image: url(https://avatars.githubusercontent.com/u/1253072?v&#x3D;3)"><span class="hidden">Tim Birkett's Picture</span></a>
            </figure>

            <section class="author">
                <h4><a href="http://www.pysysops.com/author/pysysops/">Tim Birkett</a></h4>

                    <p>Read <a href="http://www.pysysops.com/author/pysysops/">more posts</a> by this author.</p>
                <div class="author-meta">
                    <span class="author-location icon-location">Manchester, United Kingdom</span>
                    
                </div>
            </section>


            <section class="share">
                <h4>Share this post</h4>
                <a class="icon-twitter" href="https://twitter.com/intent/tweet?text=Puppet%20-%20Common%20Anti-Patterns&amp;url=http://www.pysysops.com/2016/11/10/1123-Puppet-Common-Anti-Patterns.html"
                    onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <span class="hidden">Twitter</span>
                </a>
                <a class="icon-facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://www.pysysops.com/2016/11/10/1123-Puppet-Common-Anti-Patterns.html"
                    onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <span class="hidden">Facebook</span>
                </a>
                <a class="icon-google-plus" href="https://plus.google.com/share?url=http://www.pysysops.com/2016/11/10/1123-Puppet-Common-Anti-Patterns.html"
                   onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <span class="hidden">Google+</span>
                </a>
            </section>

        </footer>


        <section class="post-comments">
          <div id="disqus_thread"></div>
          <script type="text/javascript">
          var disqus_shortname = 'pysysops'; // required: replace example with your forum shortname
          /* * * DON'T EDIT BELOW THIS LINE * * */
          (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
          })();
          </script>
          <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
          <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
        </section>


    </article>

</main>

<aside class="read-next">
</aside>



        <footer class="site-footer clearfix">
            <section class="copyright"><a href="http://www.pysysops.com">Tim Birkett </a> &copy; 2017</section>
            <section class="poweredby">Proudly published with <a href="http://hubpress.io">HubPress</a></section>
        </footer>

    </div>

    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.0.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/moment.js/2.9.0/moment-with-locales.min.js?v="></script> <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/8.4/highlight.min.js?v="></script> 
      <script type="text/javascript">
        jQuery( document ).ready(function() {
          // change date with ago
          jQuery('ago.ago').each(function(){
            var element = jQuery(this).parent();
            element.html( moment(element.text()).fromNow());
          });
        });

        hljs.initHighlightingOnLoad();
      </script>

    <script type="text/javascript" src="//www.pysysops.com/themes/casper/assets/js/jquery.fitvids.js?v=1484110163745"></script>
    <script type="text/javascript" src="//www.pysysops.com/themes/casper/assets/js/index.js?v=1484110163745"></script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-90121848-1', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
