= Easy Infrastructure Testing with Goss
:hp-tags: Configuration Management, Testing, Security, Monitoring, goss
:hp-image: /images/covers/cover-01.jpg


In the world of infrastructure new servers, VMs, containers or applications are often manually validated by a human and some form of build document or checkbox exercise takes place. Even with configuration management, mistakes happen and humans miss things.

Wouldn't it be great if there were an easy way to automatically validate new servers before they are live and we find the problems in production? Well, there is!

== What is Goss?
https://github.com/aelsabbahy/goss[Goss] is a tool that let's you easily test and validate infrastructure. Like http://serverspec.org/[Serverspec] but without all the code. Goss allows you to define what a piece of infrastructure should look like with YAML or JSON. This is made even easier for us with the ability to auto add resources to the Goss configuration.

Goss allows you to validate many different resource types such as files, users, groups, packages, services and http connectivity. You can read the full https://github.com/aelsabbahy/goss/blob/master/docs/manual.md#available-tests[Goss documentation].

== Why Goss? 
Well, a few things make goss awesome: 

* Written in Go - it's a self contained binary with no dependencies on other libraries or Ruby. 
* It's super fast - taking advantages of Go's concurrency model tests are executed and returned almost instantly.
* It's easy to get started with - defining resources in YAML or JSON makes it easy for infrastructure teams who may have limited development experience to get to grips with.

=== An Example
We build a web server running Apache. Someone then checks that Apache `httpd` package is the correct version `2.4.25`, the `deployment` user is in the `www-data` group, there is an application directory at `/srv/www/app`, we check the `httpd` service is running, we can connect to the application at `http://localhost/app` and going to `http://localhost/` gives a `404` error within 1 second.

With Goss, the YAML configuration would look like this:

```yaml
---
package:
  httpd:
    installed: true
    versions:
    - 2.4.25
user:
  deployment:
    exists: true
    groups:
    - deployment
    - www-data
file:
  /srv/www/app:
    exists: true
    filetype: directory
service: 
  httpd:
    enabled: true
    running: true
http:
  http://localhost/app:
    status: 200
    timeout: 1000
  http://localhost:
    status: 404
    timeout: 1000    
```

That's quite simple, easy to understand what is being validated and can be used to consistently validate all servers of that configuration.

== Server Validation and Monitoring
All this validation of files, processes, services, ports etc... sounds familiar. It's something that we quite often try to achieve with our monitoring tools like Nagios, Zabbix or Sensu.

With Goss we can create a single monitoring check for validation of a piece of infrastructure that may test many resources. Goss has outputs to make this really easy. The nagios_verbose output gives feedback on what is wrong:

image::https://cloud.githubusercontent.com/assets/1253072/18037748/76f65a32-6d83-11e6-9aba-bceabb8430a3.png[Goss - nagios_verbose output]

Server validation can now become part of your monitoring pipeline ensuring that any problems are identified quickly with a single monitoring check.

WARNING: Goss won't replace all of your checks, it doesn't check things like HDD space, RAM usage or errors in log files. But it makes a sweet addition to server / service monitoring.

== HTTP Health Endpoint
It's becoming increasingly common to expose health endpoints for applications and services. Google did this with their Borgmon monitoring system, https://prometheus.io/[Prometheus] also uses this scrape model and there are several libraries out there such as http://metrics.dropwizard.io/3.1.0/[Dropwizard Metrics] or http://blog.kristian.io/django-health-check/[Django Health Check] to name a few. 

Goss has a `serve` command that exposes a http endpoint with configurable output such as json. This makes it easy to create a simpe UI or utilise something like https://www.phpservermonitor.org/[PHP Server Monitor] to show the validation status of each piece of infrastructure.

== Final Thoughts

I hope with that with some learning and experimentation you can see the value of validation testing your infrastructure and building validation into your monitoring systems. Goss is a young project and currently only supports Linux although it is active and open to contributions. You can help out by opening issues and pull requests.

I'll follow up with more in-depth posts Goss related posts in the future. Thanks for reading!
